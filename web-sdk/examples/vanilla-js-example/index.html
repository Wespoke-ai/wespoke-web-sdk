<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wespoke SDK - Vanilla JS Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: hsl(0 0% 3.5%);
      color: hsl(0 0% 98%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: hsl(178 30% 43%);
      font-size: 1.875rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .subtitle {
      text-align: center;
      margin-bottom: 30px;
      color: hsl(0 0% 75%);
      font-size: 0.875rem;
      font-weight: 400;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: hsl(0 0% 4%);
      border-radius: 0.75rem;
      padding: 20px;
      border: 1px solid hsl(0 0% 14%);
    }

    .panel h2 {
      color: hsl(178 30% 43%);
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid hsl(0 0% 14%);
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: hsl(0 0% 75%);
      font-size: 0.875rem;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: hsl(0 0% 8%);
      border: 1px solid hsl(0 0% 14%);
      border-radius: 0.375rem;
      color: hsl(0 0% 98%);
      font-size: 0.875rem;
      transition: border-color 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: hsl(178 30% 43%);
      box-shadow: 0 0 0 3px hsl(178 30% 43% / 0.1);
    }

    input::placeholder {
      color: hsl(0 0% 60%);
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 100px;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      outline: none;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-primary {
      background: hsl(178 30% 43%);
      color: hsl(0 0% 98%);
    }

    .btn-primary:hover:not(:disabled) {
      background: hsl(178 30% 43% / 0.9);
    }

    .btn-primary:active:not(:disabled) {
      background: hsl(178 30% 38%);
    }

    .btn-danger {
      background: hsl(0 62.8% 30.6%);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: hsl(0 62.8% 30.6% / 0.9);
    }

    .btn-danger:active:not(:disabled) {
      background: hsl(0 62.8% 25%);
    }

    .btn-secondary {
      background: hsl(0 0% 8%);
      color: hsl(0 0% 98%);
      border: 1px solid hsl(0 0% 14%);
    }

    .btn-secondary:hover:not(:disabled) {
      background: hsl(0 0% 14% / 0.5);
    }

    .btn-secondary:active:not(:disabled) {
      background: hsl(0 0% 14%);
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .status-idle { background: hsl(0 0% 75%); color: hsl(0 0% 3.5%); }
    .status-connecting { background: hsl(38 92% 50%); color: hsl(0 0% 3.5%); }
    .status-connected { background: hsl(142 71% 45%); color: hsl(0 0% 98%); }
    .status-disconnecting { background: hsl(30 80% 55%); color: hsl(0 0% 3.5%); }
    .status-disconnected { background: hsl(0 0% 50%); color: hsl(0 0% 98%); }
    .status-error { background: hsl(0 62.8% 30.6%); color: hsl(0 0% 98%); }

    .events-container {
      background: hsl(0 0% 0% / 0.3);
      border-radius: 0.375rem;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.75rem;
      border: 1px solid hsl(0 0% 14%);
    }

    .event-item {
      margin-bottom: 8px;
      padding: 8px;
      background: hsl(0 0% 8%);
      border-radius: 0.375rem;
      border-left: 3px solid hsl(178 30% 43%);
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-height: 150px;
      overflow-y: auto;
    }

    .event-time {
      color: hsl(0 0% 60%);
      font-size: 0.7rem;
      display: inline-block;
      min-width: 70px;
    }

    .event-type {
      color: hsl(178 30% 43%);
      font-weight: 600;
      margin: 0 8px;
      display: inline-block;
    }

    .event-data {
      color: hsl(0 0% 75%);
      display: block;
      margin-top: 4px;
      padding-left: 78px;
      word-break: break-all;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: pre-wrap;
      font-size: 0.7rem;
      line-height: 1.4;
    }

    .messages-container {
      background: hsl(0 0% 0% / 0.3);
      border-radius: 0.375rem;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid hsl(0 0% 14%);
    }

    .message-item {
      margin-bottom: 12px;
      padding: 10px;
      background: hsl(0 0% 8%);
      border-radius: 0.375rem;
      border: 1px solid hsl(0 0% 14%);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .message-role {
      font-weight: 600;
      margin-bottom: 5px;
      color: hsl(178 30% 43%);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .message-role.user { color: hsl(217 91% 60%); }
    .message-role.assistant { color: hsl(178 30% 43%); }
    .message-role.tool { color: hsl(280 65% 60%); }

    .message-content {
      color: hsl(0 0% 90%);
      line-height: 1.6;
      font-size: 0.875rem;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .info-item {
      padding: 10px;
      background: hsl(0 0% 0% / 0.3);
      border-radius: 0.375rem;
    }

    .info-label {
      color: hsl(0 0% 60%);
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .info-value {
      color: hsl(0 0% 98%);
      font-size: 1rem;
      font-weight: 600;
    }

    .clear-btn {
      padding: 6px 12px;
      font-size: 0.8rem;
      margin-top: 10px;
    }

    .error-message {
      background: hsl(0 62.8% 30.6% / 0.2);
      border: 1px solid hsl(0 62.8% 30.6%);
      border-radius: 0.375rem;
      padding: 12px;
      margin-top: 10px;
      color: hsl(0 84% 60%);
    }

    .success-message {
      background: hsl(142 71% 45% / 0.2);
      border: 1px solid hsl(142 71% 45%);
      border-radius: 0.375rem;
      padding: 12px;
      margin-top: 10px;
      color: hsl(142 76% 65%);
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: hsl(0 0% 0% / 0.3);
      border-radius: 0.25rem;
    }

    ::-webkit-scrollbar-thumb {
      background: hsl(178 30% 43% / 0.5);
      border-radius: 0.25rem;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: hsl(178 30% 43% / 0.7);
    }

    .info-box {
      background: hsl(178 30% 43% / 0.1);
      border: 1px solid hsl(178 30% 43% / 0.3);
      border-radius: 0.5rem;
      padding: 15px;
      margin-bottom: 20px;
      color: hsl(0 0% 70%);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .info-box strong {
      color: hsl(178 30% 43%);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wespoke Web SDK Test</h1>
    <p class="subtitle">Vanilla JavaScript Integration Example (REST API Mode)</p>

    <div class="info-box">
      <strong>REST API Mode:</strong> This SDK now uses REST API endpoints for call control (end call, mute, send messages) while maintaining WebRTC for high-quality audio streaming. All operations use your existing embed API keys (<code>pk_live_xxx</code> or <code>pk_test_xxx</code>).
    </div>

    <div class="grid">
      <!-- Configuration Panel -->
      <div class="panel">
        <h2>Configuration</h2>
        <div class="input-group">
          <label for="apiKey">API Key</label>
          <input type="text" id="apiKey" placeholder="pk_live_xxx or pk_test_xxx" value="">
        </div>
        <div class="input-group">
          <label for="assistantId">Assistant ID</label>
          <input type="text" id="assistantId" placeholder="Enter assistant ID" value="">
        </div>
        <div class="input-group">
          <label for="apiUrl">API URL (Optional)</label>
          <input type="text" id="apiUrl" placeholder="https://api.wespoke.com.tr" value="">
        </div>
        <div class="input-group">
          <label>
            <input type="checkbox" id="debugMode"> Enable Debug Mode
          </label>
        </div>
        <button class="btn-primary" id="initBtn" style="width: 100%;">Initialize SDK</button>
        <div id="initMessage"></div>
      </div>

      <!-- Call Controls Panel -->
      <div class="panel">
        <h2>Call Controls</h2>
        <div class="status-badge status-idle" id="statusBadge">IDLE</div>
        <div class="button-group">
          <button class="btn-primary" id="startCallBtn" disabled>Start Call</button>
          <button class="btn-danger" id="endCallBtn" disabled>End Call</button>
        </div>
        <div class="button-group" style="margin-top: 10px;">
          <button class="btn-secondary" id="toggleMuteBtn" disabled>Mute</button>
          <button class="btn-secondary" id="sendMessageBtn" disabled>Send Message</button>
        </div>
        <div class="info-grid" style="margin-top: 15px;">
          <div class="info-item">
            <div class="info-label">Call ID</div>
            <div class="info-value" id="callIdValue">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Microphone</div>
            <div class="info-value" id="micValue">Unmuted</div>
          </div>
          <div class="info-item">
            <div class="info-label">Assistant Speaking</div>
            <div class="info-value" id="speakingValue">No</div>
          </div>
          <div class="info-item">
            <div class="info-label">Connection Quality</div>
            <div class="info-value" id="qualityValue">-</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Messages Panel -->
      <div class="panel">
        <h2>Conversation</h2>
        <div class="messages-container" id="messagesContainer">
          <p style="color: hsl(0 0% 60%); text-align: center; padding: 20px;">No messages yet</p>
        </div>
        <button class="btn-secondary clear-btn" id="clearMessagesBtn">Clear Messages</button>
      </div>

      <!-- Events Panel -->
      <div class="panel">
        <h2>Events Log</h2>
        <div class="events-container" id="eventsContainer">
          <p style="color: hsl(0 0% 60%); text-align: center; padding: 20px;">No events yet</p>
        </div>
        <button class="btn-secondary clear-btn" id="clearEventsBtn">Clear Events</button>
      </div>
    </div>
  </div>

  <!-- Load LiveKit dependency first -->
  <script src="https://unpkg.com/livekit-client@2.16.0/dist/livekit-client.umd.js"></script>

  <!-- Load SDK from local build (served via symlink or copy) -->
  <script src="wespoke.umd.js"></script>

  <script>
    // Global state
    let wespoke = null;
    let isInitialized = false;

    // DOM elements
    const apiKeyInput = document.getElementById('apiKey');
    const assistantIdInput = document.getElementById('assistantId');
    const apiUrlInput = document.getElementById('apiUrl');
    const debugModeCheckbox = document.getElementById('debugMode');
    const initBtn = document.getElementById('initBtn');
    const initMessage = document.getElementById('initMessage');

    const statusBadge = document.getElementById('statusBadge');
    const startCallBtn = document.getElementById('startCallBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const toggleMuteBtn = document.getElementById('toggleMuteBtn');
    const sendMessageBtn = document.getElementById('sendMessageBtn');

    const callIdValue = document.getElementById('callIdValue');
    const micValue = document.getElementById('micValue');
    const speakingValue = document.getElementById('speakingValue');
    const qualityValue = document.getElementById('qualityValue');

    const messagesContainer = document.getElementById('messagesContainer');
    const eventsContainer = document.getElementById('eventsContainer');
    const clearMessagesBtn = document.getElementById('clearMessagesBtn');
    const clearEventsBtn = document.getElementById('clearEventsBtn');

    // LocalStorage keys
    const STORAGE_KEYS = {
      API_KEY: 'wespoke_test_api_key',
      ASSISTANT_ID: 'wespoke_test_assistant_id',
      API_URL: 'wespoke_test_api_url',
      DEBUG_MODE: 'wespoke_test_debug_mode'
    };

    // Load saved settings from localStorage
    function loadSettings() {
      const savedApiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
      const savedAssistantId = localStorage.getItem(STORAGE_KEYS.ASSISTANT_ID);
      const savedApiUrl = localStorage.getItem(STORAGE_KEYS.API_URL);
      const savedDebugMode = localStorage.getItem(STORAGE_KEYS.DEBUG_MODE);

      if (savedApiKey) apiKeyInput.value = savedApiKey;
      if (savedAssistantId) assistantIdInput.value = savedAssistantId;
      if (savedApiUrl) apiUrlInput.value = savedApiUrl;
      if (savedDebugMode) debugModeCheckbox.checked = savedDebugMode === 'true';
    }

    // Save settings to localStorage
    function saveSettings() {
      localStorage.setItem(STORAGE_KEYS.API_KEY, apiKeyInput.value.trim());
      localStorage.setItem(STORAGE_KEYS.ASSISTANT_ID, assistantIdInput.value.trim());
      localStorage.setItem(STORAGE_KEYS.API_URL, apiUrlInput.value.trim());
      localStorage.setItem(STORAGE_KEYS.DEBUG_MODE, debugModeCheckbox.checked.toString());
    }

    // Load settings on page load
    loadSettings();

    // Save settings when they change
    apiKeyInput.addEventListener('input', saveSettings);
    assistantIdInput.addEventListener('input', saveSettings);
    apiUrlInput.addEventListener('input', saveSettings);
    debugModeCheckbox.addEventListener('change', saveSettings);

    // Utility functions
    function logEvent(type, data = null) {
      const time = new Date().toLocaleTimeString();
      const eventHtml = `
        <div class="event-item">
          <span class="event-time">${time}</span>
          <span class="event-type">${type}</span>
          ${data ? `<span class="event-data">${JSON.stringify(data)}</span>` : ''}
        </div>
      `;

      if (eventsContainer.querySelector('p')) {
        eventsContainer.innerHTML = '';
      }

      eventsContainer.insertAdjacentHTML('afterbegin', eventHtml);
    }

    function addMessage(role, content) {
      const messageHtml = `
        <div class="message-item">
          <div class="message-role ${role}">${role.toUpperCase()}</div>
          <div class="message-content">${content}</div>
        </div>
      `;

      if (messagesContainer.querySelector('p')) {
        messagesContainer.innerHTML = '';
      }

      messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function updateStatus(state) {
      statusBadge.className = `status-badge status-${state.toLowerCase()}`;
      statusBadge.textContent = state.toUpperCase();

      const isConnected = state === 'connected';
      const isIdle = state === 'idle' || state === 'disconnected';

      startCallBtn.disabled = !isIdle || !isInitialized;
      endCallBtn.disabled = !isConnected;
      toggleMuteBtn.disabled = !isConnected;
      sendMessageBtn.disabled = !isConnected;
    }

    function showMessage(message, isError = false) {
      initMessage.className = isError ? 'error-message' : 'success-message';
      initMessage.textContent = message;
      setTimeout(() => {
        initMessage.textContent = '';
        initMessage.className = '';
      }, 5000);
    }

    // Initialize SDK
    initBtn.addEventListener('click', () => {
      const apiKey = apiKeyInput.value.trim();

      if (!apiKey) {
        showMessage('Please enter an API key', true);
        return;
      }

      try {
        const config = {
          apiKey: apiKey,
          debug: debugModeCheckbox.checked
        };

        if (apiUrlInput.value.trim()) {
          config.apiUrl = apiUrlInput.value.trim();
        }

        // Destroy existing instance if any
        if (wespoke) {
          wespoke.destroy();
        }

        // Create new instance
        wespoke = new Wespoke.Wespoke(config);
        isInitialized = true;

        // Set up event listeners
        setupEventListeners();

        showMessage('SDK initialized successfully!');
        logEvent('SDK_INITIALIZED', { apiKey: apiKey.substring(0, 15) + '...' });

        startCallBtn.disabled = false;
        initBtn.textContent = 'Re-initialize SDK';

      } catch (error) {
        showMessage('Failed to initialize SDK: ' + error.message, true);
        logEvent('INIT_ERROR', { error: error.message });
      }
    });

    // Set up event listeners
    function setupEventListeners() {
      // Connection events
      wespoke.on('connected', () => {
        logEvent('CONNECTED');
        callIdValue.textContent = wespoke.getCallId() || '-';
      });

      wespoke.on('disconnected', (reason) => {
        logEvent('DISCONNECTED', { reason });
        callIdValue.textContent = '-';
      });

      wespoke.on('reconnecting', () => {
        logEvent('RECONNECTING');
      });

      wespoke.on('reconnected', () => {
        logEvent('RECONNECTED');
      });

      wespoke.on('stateChange', (state) => {
        logEvent('STATE_CHANGE', { state });
        updateStatus(state);
      });

      wespoke.on('connectionQualityChanged', (quality) => {
        logEvent('CONNECTION_QUALITY', { quality });
        qualityValue.textContent = quality;
      });

      // Conversation events
      wespoke.on('message', (message) => {
        logEvent('MESSAGE', { role: message.role, content: message.content.substring(0, 50) });
        addMessage(message.role, message.content);
      });

      wespoke.on('transcription', (transcription) => {
        logEvent('TRANSCRIPTION', { text: transcription.text, final: transcription.isFinal });
      });

      wespoke.on('assistantSpeaking', (speaking) => {
        logEvent('ASSISTANT_SPEAKING', { speaking });
        speakingValue.textContent = speaking ? 'Yes' : 'No';
      });

      // Audio events
      wespoke.on('microphoneMuted', (muted) => {
        logEvent('MICROPHONE_MUTED', { muted });
        micValue.textContent = muted ? 'Muted' : 'Unmuted';
        toggleMuteBtn.textContent = muted ? 'Unmute' : 'Mute';
      });

      // Tool events
      wespoke.on('toolEvent', (event) => {
        logEvent('TOOL_EVENT', { tool: event.toolName, type: event.type });
      });

      // Call events
      wespoke.on('callEnding', (event) => {
        logEvent('CALL_ENDING', { reason: event.reason });
      });

      wespoke.on('bargeIn', () => {
        logEvent('BARGE_IN');
      });

      wespoke.on('metrics', (metrics) => {
        logEvent('METRICS', metrics);
      });

      // Error events
      wespoke.on('error', (error) => {
        logEvent('ERROR', { message: error.message, code: error.code });
        showMessage('Error: ' + error.message, true);
      });
    }

    // Call controls
    startCallBtn.addEventListener('click', async () => {
      const assistantId = assistantIdInput.value.trim();

      if (!assistantId) {
        showMessage('Please enter an assistant ID', true);
        return;
      }

      try {
        startCallBtn.disabled = true;
        startCallBtn.textContent = 'Starting...';

        await wespoke.startCall(assistantId, {
          metadata: {
            userId: 'test-user-' + Date.now(),
            sessionId: 'session-' + Date.now(),
            customData: { source: 'vanilla-js-test' }
          }
        });

        startCallBtn.textContent = 'Start Call';
      } catch (error) {
        showMessage('Failed to start call: ' + error.message, true);
        startCallBtn.disabled = false;
        startCallBtn.textContent = 'Start Call';
      }
    });

    endCallBtn.addEventListener('click', async () => {
      try {
        await wespoke.endCall();
      } catch (error) {
        showMessage('Failed to end call: ' + error.message, true);
      }
    });

    toggleMuteBtn.addEventListener('click', async () => {
      try {
        await wespoke.toggleMute();
      } catch (error) {
        showMessage('Failed to toggle mute: ' + error.message, true);
      }
    });

    sendMessageBtn.addEventListener('click', async () => {
      const message = prompt('Enter message to send:');
      if (message && message.trim()) {
        try {
          sendMessageBtn.disabled = true;
          sendMessageBtn.textContent = 'Sending...';

          await wespoke.sendMessage(message.trim());
          logEvent('MESSAGE_SENT', { message: message.trim() });

          sendMessageBtn.disabled = false;
          sendMessageBtn.textContent = 'Send Message';
        } catch (error) {
          showMessage('Failed to send message: ' + error.message, true);
          sendMessageBtn.disabled = false;
          sendMessageBtn.textContent = 'Send Message';
        }
      }
    });

    // Clear buttons
    clearMessagesBtn.addEventListener('click', () => {
      messagesContainer.innerHTML = '<p style="color: hsl(0 0% 60%); text-align: center; padding: 20px;">No messages yet</p>';
    });

    clearEventsBtn.addEventListener('click', () => {
      eventsContainer.innerHTML = '<p style="color: hsl(0 0% 60%); text-align: center; padding: 20px;">No events yet</p>';
    });

    // Initialize status
    updateStatus('idle');
  </script>
</body>
</html>
